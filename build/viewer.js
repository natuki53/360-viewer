(()=>{const e=new Set;let t=null,n=null;function i(){return t||(t={isMobile:o(),isMac:/Mac|Macintosh|MacIntel|MacPPC|Mac68K/i.test(navigator.userAgent),webglSupported:s(),hardwareAccelerationEnabled:r(),userAgent:navigator.userAgent},t)}function o(){const e="ontouchstart"in window||navigator.maxTouchPoints>0,t=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),n=window.innerWidth;return/Mac|Macintosh|MacIntel|MacPPC|Mac68K/i.test(navigator.userAgent),navigator.userAgent,e&&(t||n<=768)}function s(){try{const e=document.createElement("canvas"),t=e.getContext("webgl")||e.getContext("experimental-webgl");if(!t)return!1;const n=t.createProgram();if(!n)return!1;const i=t.createShader(t.VERTEX_SHADER),o=t.createShader(t.FRAGMENT_SHADER);return!(!i||!o||(t.deleteShader(i),t.deleteShader(o),t.deleteProgram(n),0))}catch(e){return!1}}function r(){try{const e=document.createElement("canvas"),t=e.getContext("webgl")||e.getContext("experimental-webgl");if(!t)return!1;const n=t.getExtension("WEBGL_debug_renderer_info");return!n||!t.getParameter(n.UNMASKED_RENDERER_WEBGL).toLowerCase().includes("software")}catch(e){return!1}}class a{constructor(e,t){this.container=e,this.imageUrl=t,this.scene=null,this.camera=null,this.renderer=null,this.sphere=null,this.isUserInteracting=!1,this.onMouseDownMouseX=0,this.onMouseDownMouseY=0,this.lon=90,this.lat=0,this.onMouseDownLon=0,this.onMouseDownLat=0,this.phi=0,this.theta=0,this.autoRotate=!0,this.autoRotateTimeout=null,this.isFullscreen=!1,this.isDisposed=!1,this.isVisible=!0,this.intersectionObserver=null,this.lastTime=0,this.autoRotateSpeed=3;const n=i();this.isMobile=n.isMobile,this.isMac=n.isMac,this.webglSupported=n.webglSupported,this.hardwareAccelerationEnabled=n.hardwareAccelerationEnabled,this.boundOnDocumentMouseDown=this.onDocumentMouseDown.bind(this),this.boundOnDocumentMouseMove=this.onDocumentMouseMove.bind(this),this.boundOnDocumentMouseUp=this.onDocumentMouseUp.bind(this),this.boundOnDocumentTouchStart=this.onDocumentTouchStart.bind(this),this.boundOnDocumentTouchMove=this.onDocumentTouchMove.bind(this),this.boundOnDocumentTouchEnd=this.onDocumentTouchEnd.bind(this),this.boundOnWindowResize=this.onWindowResize.bind(this),this.boundHandleFullscreenChange=this.handleFullscreenChange.bind(this),this.boundHandleEscapeKey=this.handleEscapeKey.bind(this),this.boundHandleBeforeUnload=this.dispose.bind(this),this.boundPreventScroll=this.preventScroll.bind(this),this.boundOnContainerClick=this.onContainerClick.bind(this),this.boundHandleContextLost=this.handleContextLost.bind(this),this.boundHandleContextRestored=this.handleContextRestored.bind(this),this.boundZoomInClick=null,this.boundZoomOutClick=null,this.boundZoomInTouch=null,this.boundZoomOutTouch=null,this.boundFullscreenClick=null,this.observer=new IntersectionObserver((e=>{e.forEach((e=>{e.isIntersecting?this.activate():this.deactivate()}))}),{threshold:.1}),this.webglSupported,this.hardwareAccelerationEnabled,this.init(),this.setupIntersectionObserver()}setupIntersectionObserver(){"IntersectionObserver"in window&&(this.intersectionObserver=new IntersectionObserver((e=>{e.forEach((e=>{this.isVisible=e.isIntersecting,this.isVisible?this.startAnimation():this.stopAnimation()}))}),{threshold:.1}),this.intersectionObserver.observe(this.container))}init(){try{this.scene=new THREE.Scene,this.camera=new THREE.PerspectiveCamera(75,this.container.clientWidth/this.container.clientHeight,1,1100),this.camera.target=new THREE.Vector3(0,0,0),this.renderer=this.createRenderer(),this.container.appendChild(this.renderer.domElement),this.renderer.isCanvas2D||(this.renderer.domElement.addEventListener("webglcontextlost",this.boundHandleContextLost,!1),this.renderer.domElement.addEventListener("webglcontextrestored",this.boundHandleContextRestored,!1))}catch(e){return console.error("ビューアーの初期化に失敗しました:",e),void this.showErrorMessage("360°ビューアーの初期化に失敗しました。")}this.controlsContainer=document.createElement("div"),this.controlsContainer.className="psv-controls-container",this.container.appendChild(this.controlsContainer);const e=new THREE.SphereGeometry(500,60,40);e.scale(-1,1,1);const t=new THREE.TextureLoader,n=void 0!==THREE.SRGBColorSpace;n||(t.encoding=THREE.sRGBEncoding);const i=t.load(this.imageUrl,(()=>{n?i.colorSpace=THREE.SRGBColorSpace:i.encoding=THREE.sRGBEncoding,i.wrapS=THREE.RepeatWrapping,i.repeat.x=1,i.minFilter=THREE.LinearFilter,i.magFilter=THREE.LinearFilter,i.generateMipmaps=!1;const t=new THREE.MeshBasicMaterial({map:i,side:THREE.DoubleSide});this.sphere=new THREE.Mesh(e,t),this.scene.add(this.sphere)}),void 0,(e=>{console.error("テクスチャの読み込みに失敗しました:",e),this.showErrorMessage("360°画像の読み込みに失敗しました。画像のURLを確認してください。")}));this.observer.observe(this.container),this.setupEventListeners(),this.activate()}handleContextLost(e){e.preventDefault(),this.stopAnimation(),this.isMobile&&this.webglSupported&&(this.showErrorMessage("WebGLが利用できません。Canvas2Dモードに切り替えます..."),setTimeout((()=>{this.switchToCanvas2D()}),1e3))}handleContextRestored(){this.startAnimation()}switchToCanvas2D(){this.renderer&&this.renderer.domElement&&this.container.removeChild(this.renderer.domElement),this.renderer=this.createCanvas2DRenderer(),this.container.appendChild(this.renderer.domElement),this.startAnimation()}createRenderer(){if(!this.webglSupported)return this.createCanvas2DRenderer();try{const e=function(){if(n)return n;const e=i();return n={rendererOptions:{antialias:!0,preserveDrawingBuffer:!0},pixelRatio:1},e.isMobile?(n.rendererOptions.powerPreference="low-power",n.rendererOptions.antialias=!1,n.rendererOptions.preserveDrawingBuffer=!1,n.pixelRatio=Math.min(window.devicePixelRatio,1.5)):e.hardwareAccelerationEnabled?e.isMac?(n.rendererOptions.powerPreference="high-performance",n.pixelRatio=Math.min(window.devicePixelRatio,3)):(n.rendererOptions.powerPreference="low-power",n.pixelRatio=Math.min(window.devicePixelRatio,2)):(n.rendererOptions.powerPreference="low-power",n.rendererOptions.failIfMajorPerformanceCaveat=!1,n.pixelRatio=1),n}();let t;if(this.isMobile){const n=[e.rendererOptions,{antialias:!1,preserveDrawingBuffer:!1},{antialias:!1},{}];for(let e=0;e<n.length;e++)try{if(t=new THREE.WebGLRenderer(n[e]),t&&t.domElement&&t.getContext())break;throw new Error(`WebGL renderer creation failed with config ${e+1}`)}catch(t){if(e===n.length-1)throw t}}else if(t=new THREE.WebGLRenderer(e.rendererOptions),!t||!t.domElement||!t.getContext())throw new Error("WebGL renderer creation failed");return t.setPixelRatio(e.pixelRatio),t.setSize(this.container.clientWidth,this.container.clientHeight),void 0!==THREE.SRGBColorSpace?t.outputColorSpace=THREE.SRGBColorSpace:(t.outputEncoding=THREE.sRGBEncoding,t.gammaFactor=2.2,t.gammaOutput=!0),t}catch(e){return console.error("WebGLレンダラーの作成に失敗しました:",e),this.createCanvas2DRenderer()}}createCanvas2DRenderer(){const e=document.createElement("canvas"),t=e.getContext("2d");return e.width=this.container.clientWidth,e.height=this.container.clientHeight,{domElement:e,context:t,isCanvas2D:!0,setSize:function(t,n){e.width=t,e.height=n},setPixelRatio:function(e){},render:function(e,t){this.renderCanvas2D(e,t)}.bind(this),dispose:function(){e.remove()}}}renderCanvas2D(e,t){if(!this.renderer.isCanvas2D||!this.sphere)return;const n=this.renderer.context,i=this.renderer.domElement;if(n.clearRect(0,0,i.width,i.height),this.sphere&&this.sphere.material&&this.sphere.material.map){const e=this.sphere.material.map.image;e&&e.complete&&this.drawPanoramaOnCanvas(n,e,i.width,i.height)}}drawPanoramaOnCanvas(e,t,n,i){e.clearRect(0,0,n,i);const o=document.createElement("canvas");o.width=t.width,o.height=t.height;const s=o.getContext("2d");s.drawImage(t,0,0);const r=s.getImageData(0,0,t.width,t.height).data,a=this.camera.fov,h=n/i,l=THREE.MathUtils.degToRad(90-this.lat),c=THREE.MathUtils.degToRad(this.lon),u=-100*Math.sin(l)*Math.cos(c),d=-100*Math.cos(l),m=-100*Math.sin(l)*Math.sin(c),p=Math.sqrt(u*u+d*d+m*m),v=u/p,g=d/p,b=m/p,E=0*g-1*b,w=0*b-0*v,f=1*v-0*g,M=Math.sqrt(E*E+w*w+f*f),C=E/M,x=w/M,D=f/M,R=x*b-D*g,T=D*v-C*b,O=C*g-x*v,y=THREE.MathUtils.degToRad(a),L=Math.tan(y/2);for(let o=0;o<i;o+=1)for(let s=0;s<n;s+=1){const a=(2*s/n-1)*h*L,l=(1-2*o/i)*L,c=v+a*C+l*R,u=g+a*x+l*T,d=b+a*D+l*O,m=Math.sqrt(c*c+u*u+d*d),p=c/m,E=u/m,w=d/m,f=Math.acos(E),M=(Math.atan2(w,p)+Math.PI)/(2*Math.PI),y=f/Math.PI,B=Math.floor(M*(t.width-1)),F=Math.floor(y*(t.height-1));if(B>=0&&B<t.width&&F>=0&&F<t.height){const n=4*(F*t.width+B),i=r[n],a=r[n+1],h=r[n+2],l=r[n+3]/255;e.fillStyle=`rgba(${i}, ${a}, ${h}, ${l})`,e.fillRect(s,o,1,1)}}}showErrorMessage(e){const t=this.container.querySelector(".psv-error-message");t&&t.remove();const n=document.createElement("div");n.className="psv-error-message",n.style.cssText="\n            position: absolute;\n            top: 10px;\n            left: 10px;\n            width: 30px;\n            height: 30px;\n            background: rgba(255, 165, 0, 0.9);\n            color: white;\n            border-radius: 50%;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            font-family: Arial, sans-serif;\n            font-size: 16px;\n            font-weight: bold;\n            cursor: pointer;\n            z-index: 1000;\n            user-select: none;\n            transition: transform 0.2s;\n        ",n.textContent="ℹ",n.title="Canvas2Dモードで動作中 - クリック/タップで詳細表示",n.addEventListener("mouseenter",(()=>{n.style.transform="scale(1.1)"})),n.addEventListener("mouseleave",(()=>{n.style.transform="scale(1)"})),n.addEventListener("click",(t=>{t.preventDefault(),t.stopPropagation(),this.showDetailedError(e)})),n.addEventListener("touchend",(t=>{t.preventDefault(),t.stopPropagation(),this.showDetailedError(e)})),this.container.appendChild(n)}showDetailedError(e){const t=this.container.querySelector(".psv-detailed-error");if(t)return void t.remove();const n=document.createElement("div");n.className="psv-detailed-error",n.style.cssText="\n            position: absolute;\n            top: 50px;\n            left: 10px;\n            background: rgba(0, 0, 0, 0.95);\n            color: white;\n            padding: 20px;\n            border-radius: 12px;\n            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;\n            font-size: 14px;\n            max-width: 350px;\n            z-index: 1001;\n            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.5);\n            line-height: 1.6;\n            animation: fadeIn 0.3s ease-in-out;\n        ",n.innerHTML='\n            <div style="margin-bottom: 15px;">\n                <div style="font-size: 15px; font-weight: bold; margin-bottom: 12px; color: #FFA500;">\n                    ℹ️ お知らせ\n                </div>\n                <div style="font-size: 14px; color: #fff; line-height: 1.8;">\n                    WebGLが使用できないため画質を落として表示しています。<br>\n                    高画質で利用するにはハードウェアアクセラレーションを有効にしてください。\n                </div>\n            </div>\n            \n            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255, 255, 255, 0.2);">\n                <div style="font-size: 12px; color: #999; text-align: center;">\n                    クリック/タップで閉じる\n                </div>\n            </div>\n        ',n.addEventListener("click",(e=>{e.stopPropagation(),n.remove()})),n.addEventListener("touchend",(e=>{e.stopPropagation(),n.remove()})),this.container.appendChild(n),setTimeout((()=>{n.parentNode&&n.remove()}),1e4)}getBrowserInfo(){const e=navigator.userAgent;return e.indexOf("Chrome")>-1&&-1===e.indexOf("Edg")?"Chrome":e.indexOf("Safari")>-1&&-1===e.indexOf("Chrome")?"Safari":e.indexOf("Firefox")>-1?"Firefox":e.indexOf("Edg")>-1?"Edge":"その他"}activate(){this.isDisposed||(e.size>=3&&Array.from(e)[0].deactivate(),e.add(this),this.startAnimation())}deactivate(){this.isDisposed||(e.delete(this),this.stopAnimation())}startAnimation(){this.isAnimating||(this.isAnimating=!0,this.animate())}stopAnimation(){this.isAnimating=!1}dispose(){this.isDisposed||(this.isDisposed=!0,this.deactivate(),this.observer.disconnect(),this.intersectionObserver&&(this.intersectionObserver.disconnect(),this.intersectionObserver=null),this.autoRotateTimeout&&(clearTimeout(this.autoRotateTimeout),this.autoRotateTimeout=null),this.sphere&&(this.sphere.geometry.dispose(),this.sphere.material.map?.dispose(),this.sphere.material.dispose(),this.scene.remove(this.sphere)),this.scene&&this.scene.clear(),this.renderer&&(this.renderer.isCanvas2D||(this.renderer.domElement.removeEventListener("webglcontextlost",this.boundHandleContextLost),this.renderer.domElement.removeEventListener("webglcontextrestored",this.boundHandleContextRestored)),this.renderer.isCanvas2D,this.renderer.dispose(),this.container.contains(this.renderer.domElement)&&this.container.removeChild(this.renderer.domElement)),this.removeEventListeners(),this.zoomInButton&&this.zoomInButton.parentNode&&this.zoomInButton.parentNode.removeChild(this.zoomInButton),this.zoomOutButton&&this.zoomOutButton.parentNode&&this.zoomOutButton.parentNode.removeChild(this.zoomOutButton),this.fullscreenButton&&this.fullscreenButton.parentNode&&this.fullscreenButton.parentNode.removeChild(this.fullscreenButton),this.controlsContainer&&this.container.contains(this.controlsContainer)&&this.container.removeChild(this.controlsContainer),this.scene=null,this.camera=null,this.renderer=null,this.sphere=null,this.controlsContainer=null,this.zoomInButton=null,this.zoomOutButton=null,this.fullscreenButton=null)}setupEventListeners(){this.isMobile||(this.fullscreenButton=document.createElement("button"),this.fullscreenButton.className="psv-btn psv-fullscreen-btn",this.fullscreenButton.title="フルスクリーン",this.fullscreenButton.innerHTML="⛶",this.boundFullscreenClick=e=>{e.stopPropagation(),this.toggleFullscreen()},this.fullscreenButton.onclick=this.boundFullscreenClick,this.container.appendChild(this.fullscreenButton)),this.zoomInButton=document.createElement("button"),this.zoomInButton.className="psv-btn psv-zoom-btn psv-zoom-in-btn",this.zoomInButton.title="ズームイン",this.zoomInButton.innerHTML="+",this.boundZoomInClick=e=>{e.stopPropagation(),this.zoomIn()},this.zoomInButton.onclick=this.boundZoomInClick,this.boundZoomInTouch=e=>{e.preventDefault(),e.stopPropagation(),this.zoomIn()},this.zoomInButton.addEventListener("touchend",this.boundZoomInTouch,{passive:!1}),this.container.appendChild(this.zoomInButton),this.zoomOutButton=document.createElement("button"),this.zoomOutButton.className="psv-btn psv-zoom-btn psv-zoom-out-btn",this.zoomOutButton.title="ズームアウト",this.zoomOutButton.innerHTML="−",this.boundZoomOutClick=e=>{e.stopPropagation(),this.zoomOut()},this.zoomOutButton.onclick=this.boundZoomOutClick,this.boundZoomOutTouch=e=>{e.preventDefault(),e.stopPropagation(),this.zoomOut()},this.zoomOutButton.addEventListener("touchend",this.boundZoomOutTouch,{passive:!1}),this.container.appendChild(this.zoomOutButton),this.container.addEventListener("mousedown",this.boundOnDocumentMouseDown,!1),this.container.addEventListener("mousemove",this.boundOnDocumentMouseMove,!1),this.container.addEventListener("mouseup",this.boundOnDocumentMouseUp,!1),this.container.addEventListener("mouseleave",this.boundOnDocumentMouseUp,!1),this.container.addEventListener("touchstart",this.boundOnDocumentTouchStart,!1),this.container.addEventListener("touchmove",this.boundOnDocumentTouchMove,!1),this.container.addEventListener("touchend",this.boundOnDocumentTouchEnd,!1),this.container.addEventListener("click",this.boundOnContainerClick,!1),this.updateCursor(),window.addEventListener("resize",this.boundOnWindowResize,!1),this.isMobile||(document.addEventListener("fullscreenchange",this.boundHandleFullscreenChange),document.addEventListener("webkitfullscreenchange",this.boundHandleFullscreenChange),document.addEventListener("mozfullscreenchange",this.boundHandleFullscreenChange),document.addEventListener("MSFullscreenChange",this.boundHandleFullscreenChange),document.addEventListener("keydown",this.boundHandleEscapeKey)),window.addEventListener("beforeunload",this.boundHandleBeforeUnload)}onContainerClick(e){e.target===this.zoomInButton||e.target===this.zoomOutButton||this.isMobile||e.target===this.fullscreenButton||(e.preventDefault(),e.stopPropagation())}removeEventListeners(){this.container&&(this.container.removeEventListener("mousedown",this.boundOnDocumentMouseDown),this.container.removeEventListener("mousemove",this.boundOnDocumentMouseMove),this.container.removeEventListener("mouseup",this.boundOnDocumentMouseUp),this.container.removeEventListener("mouseleave",this.boundOnDocumentMouseUp),this.container.removeEventListener("touchstart",this.boundOnDocumentTouchStart),this.container.removeEventListener("touchmove",this.boundOnDocumentTouchMove),this.container.removeEventListener("touchend",this.boundOnDocumentTouchEnd),this.container.removeEventListener("click",this.boundOnContainerClick)),this.zoomInButton&&(this.boundZoomInClick&&(this.zoomInButton.onclick=null),this.boundZoomInTouch&&this.zoomInButton.removeEventListener("touchend",this.boundZoomInTouch)),this.zoomOutButton&&(this.boundZoomOutClick&&(this.zoomOutButton.onclick=null),this.boundZoomOutTouch&&this.zoomOutButton.removeEventListener("touchend",this.boundZoomOutTouch)),this.fullscreenButton&&this.boundFullscreenClick&&(this.fullscreenButton.onclick=null),window.removeEventListener("resize",this.boundOnWindowResize),window.removeEventListener("beforeunload",this.boundHandleBeforeUnload),this.isMobile||(document.removeEventListener("fullscreenchange",this.boundHandleFullscreenChange),document.removeEventListener("webkitfullscreenchange",this.boundHandleFullscreenChange),document.removeEventListener("mozfullscreenchange",this.boundHandleFullscreenChange),document.removeEventListener("MSFullscreenChange",this.boundHandleFullscreenChange),document.removeEventListener("keydown",this.boundHandleEscapeKey)),document.removeEventListener("touchmove",this.boundPreventScroll)}onWindowResize(){this.camera&&this.renderer&&!this.isDisposed&&(this.camera.aspect=this.container.clientWidth/this.container.clientHeight,this.camera.updateProjectionMatrix(),this.renderer.setSize(this.container.clientWidth,this.container.clientHeight))}onDocumentMouseDown(e){e.target===this.zoomInButton||e.target===this.zoomOutButton||!this.isMobile&&e.target===this.fullscreenButton||(e.preventDefault(),this.isUserInteracting=!0,this.onMouseDownMouseX=e.clientX,this.onMouseDownMouseY=e.clientY,this.onMouseDownLon=this.lon,this.onMouseDownLat=this.lat,this.stopAutoRotate(),this.updateCursor())}onDocumentMouseMove(e){this.isUserInteracting&&(this.lon=.1*(this.onMouseDownMouseX-e.clientX)+this.onMouseDownLon,this.lat=.1*(this.onMouseDownMouseY-e.clientY)+this.onMouseDownLat),this.updateCursor()}onDocumentMouseUp(){this.isUserInteracting&&(this.isUserInteracting=!1,this.restartAutoRotateWithDelay(),this.updateCursor())}onDocumentTouchStart(e){this.isButtonTouch(e.target)||1===e.touches.length&&(e.preventDefault(),this.onMouseDownMouseX=e.touches[0].pageX,this.onMouseDownMouseY=e.touches[0].pageY,this.onMouseDownLon=this.lon,this.onMouseDownLat=this.lat,this.isUserInteracting=!0,this.stopAutoRotate(),this.updateCursor())}onDocumentTouchMove(e){this.isButtonTouch(e.target)||(1===e.touches.length&&this.isUserInteracting&&(e.preventDefault(),this.lon=.15*(this.onMouseDownMouseX-e.touches[0].pageX)+this.onMouseDownLon,this.lat=.15*(this.onMouseDownMouseY-e.touches[0].pageY)+this.onMouseDownLat),this.updateCursor())}onDocumentTouchEnd(e){this.isButtonTouch(e.target)||this.isUserInteracting&&(this.isUserInteracting=!1,this.restartAutoRotateWithDelay(),this.updateCursor())}stopAutoRotate(){this.autoRotate=!1,this.autoRotateTimeout&&(clearTimeout(this.autoRotateTimeout),this.autoRotateTimeout=null),this.lastTime=0}restartAutoRotateWithDelay(){this.autoRotateTimeout&&clearTimeout(this.autoRotateTimeout),this.autoRotateTimeout=setTimeout((()=>{this.autoRotate=!0,this.lastTime=0}),3e3)}updateCursor(){this.container&&(this.isUserInteracting?this.container.style.cursor="grabbing":this.container.style.cursor="move")}toggleFullscreen(){this.isMobile||(this.isFullscreen?this.exitFullscreen():this.enterFullscreen())}enterFullscreen(){this.isMobile||(screen.orientation&&screen.orientation.lock&&screen.orientation.lock("landscape").catch((e=>{})),this.originalParent=this.container.parentNode,this.originalNextSibling=this.container.nextSibling,this.originalPosition=this.container.style.position,this.originalTop=this.container.style.top,this.originalLeft=this.container.style.left,this.originalWidth=this.container.style.width,this.originalHeight=this.container.style.height,this.originalZIndex=this.container.style.zIndex,this.originalBackground=this.container.style.backgroundColor,this.fullscreenOverlay=document.createElement("div"),this.fullscreenOverlay.className="psv-fullscreen-overlay",this.fullscreenOverlay.style.cssText="\n            position: fixed;\n            top: 0;\n            left: 0;\n            width: 100vw;\n            height: 100vh;\n            background: #000;\n            z-index: 9999;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n        ",this.container.style.position="relative",this.container.style.width="100vw",this.container.style.height="100vh",this.container.style.paddingTop="0",this.container.style.maxWidth="none",this.container.style.maxHeight="none",this.container.style.backgroundColor="#000",this.fullscreenOverlay.appendChild(this.container),document.body.appendChild(this.fullscreenOverlay),this.tryTrueFullscreen(),this.isFullscreen=!0,this.onFullscreenChange(),document.body.style.overflow="hidden",document.addEventListener("touchmove",this.boundPreventScroll,{passive:!1}))}tryTrueFullscreen(){const e=document.documentElement;this.isMac?e.webkitRequestFullscreen?e.webkitRequestFullscreen().catch((e=>{this.tryAlternativeFullscreen()})):e.requestFullscreen?e.requestFullscreen().catch((e=>{this.tryAlternativeFullscreen()})):this.tryAlternativeFullscreen():e.requestFullscreen?e.requestFullscreen().catch((e=>{this.tryAlternativeFullscreen()})):e.webkitRequestFullscreen?e.webkitRequestFullscreen():e.mozRequestFullScreen?e.mozRequestFullScreen():e.msRequestFullscreen?e.msRequestFullscreen():this.tryAlternativeFullscreen()}tryAlternativeFullscreen(){const e=document.querySelector('meta[name="viewport"]');e&&(this.originalViewport=e.getAttribute("content"),e.setAttribute("content","width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no")),/iPhone|iPad|iPod/.test(navigator.userAgent)&&setTimeout((()=>{window.scrollTo(0,1)}),100)}preventScroll(e){return e.preventDefault(),!1}exitFullscreen(){if(screen.orientation&&screen.orientation.unlock&&screen.orientation.unlock(),this.originalViewport){const e=document.querySelector('meta[name="viewport"]');e&&e.setAttribute("content",this.originalViewport)}document.body.style.overflow="",document.removeEventListener("touchmove",this.boundPreventScroll),this.originalParent&&(this.container.style.position=this.originalPosition,this.container.style.top=this.originalTop,this.container.style.left=this.originalLeft,this.container.style.width=this.originalWidth,this.container.style.height=this.originalHeight,this.container.style.zIndex=this.originalZIndex,this.container.style.backgroundColor=this.originalBackground,this.container.style.paddingTop="56.25%",this.container.style.maxWidth="",this.container.style.maxHeight="",this.originalNextSibling?this.originalParent.insertBefore(this.container,this.originalNextSibling):this.originalParent.appendChild(this.container)),this.fullscreenOverlay&&(this.fullscreenOverlay.remove(),this.fullscreenOverlay=null),this.isMac?document.webkitExitFullscreen?document.webkitExitFullscreen():document.exitFullscreen&&document.exitFullscreen().catch((e=>{})):document.exitFullscreen?document.exitFullscreen().catch((e=>{})):document.webkitExitFullscreen?document.webkitExitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.msExitFullscreen&&document.msExitFullscreen(),this.isFullscreen=!1,this.onFullscreenChange(),setTimeout((()=>{this.onWindowResize()}),100)}onFullscreenChange(){this.onWindowResize(),!this.isMobile&&this.fullscreenButton&&(this.isFullscreen?(this.fullscreenButton.innerHTML="✕",this.fullscreenButton.title="フルスクリーン終了"):(this.fullscreenButton.innerHTML="⛶",this.fullscreenButton.title="フルスクリーン"))}animate(){this.isAnimating&&!this.isDisposed&&(requestAnimationFrame(this.animate.bind(this)),this.update())}update(){if(this.camera&&this.renderer&&!this.isDisposed&&this.isVisible){if(this.autoRotate&&!this.isUserInteracting){const e=performance.now();if(this.lastTime>0){const t=(e-this.lastTime)/1e3;this.lon+=this.autoRotateSpeed*t}this.lastTime=e}else this.lastTime=performance.now();this.lat=Math.max(-85,Math.min(85,this.lat)),this.phi=THREE.MathUtils.degToRad(90-this.lat),this.theta=THREE.MathUtils.degToRad(this.lon),this.renderer.isCanvas2D?this.renderCanvas2D(this.scene,this.camera):(this.camera.position.x=100*Math.sin(this.phi)*Math.cos(this.theta),this.camera.position.y=100*Math.cos(this.phi),this.camera.position.z=100*Math.sin(this.phi)*Math.sin(this.theta),this.camera.lookAt(this.camera.target),this.renderer.render(this.scene,this.camera))}}zoomIn(){this.camera&&!this.isDisposed&&(this.camera.fov=Math.max(30,this.camera.fov-10),this.camera.updateProjectionMatrix())}zoomOut(){this.camera&&!this.isDisposed&&(this.camera.fov=Math.min(90,this.camera.fov+10),this.camera.updateProjectionMatrix())}isButtonTouch(e){return e===this.zoomInButton||e===this.zoomOutButton||!this.isMobile&&e===this.fullscreenButton||e.closest(".psv-btn")}handleFullscreenChange(){if(this.isMobile)return;const e=!!(document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement||document.msFullscreenElement);this.isFullscreen=e,this.onFullscreenChange()}handleEscapeKey(e){this.isMobile||"Escape"===e.key&&this.isFullscreen&&this.exitFullscreen()}}document.addEventListener("DOMContentLoaded",(function(){const e=document.querySelectorAll(".psv-container"),t=new Map;e.forEach((e=>{const n=e.getAttribute("data-img");if(n){const i=new a(e,n);t.set(e,i)}})),window.addEventListener("beforeunload",(()=>{t.forEach((e=>e.dispose())),t.clear()}))}))})();