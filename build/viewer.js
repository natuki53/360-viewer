(()=>{const t=new Set;class e{constructor(t,e){this.container=t,this.imageUrl=e,this.scene=null,this.camera=null,this.renderer=null,this.sphere=null,this.isUserInteracting=!1,this.onMouseDownMouseX=0,this.onMouseDownMouseY=0,this.lon=90,this.lat=0,this.onMouseDownLon=0,this.onMouseDownLat=0,this.phi=0,this.theta=0,this.autoRotate=!0,this.autoRotateTimeout=null,this.isFullscreen=!1,this.isDisposed=!1,this.lastTime=0,this.autoRotateSpeed=3,this.isMobile=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)||window.innerWidth<=768,this.observer=new IntersectionObserver((t=>{t.forEach((t=>{t.isIntersecting?this.activate():this.deactivate()}))}),{threshold:.1}),this.init()}init(){this.scene=new THREE.Scene,this.camera=new THREE.PerspectiveCamera(75,this.container.clientWidth/this.container.clientHeight,1,1100),this.camera.target=new THREE.Vector3(0,0,0),this.renderer=this.createRenderer(),this.container.appendChild(this.renderer.domElement),this.controlsContainer=document.createElement("div"),this.controlsContainer.className="psv-controls-container",this.container.appendChild(this.controlsContainer);const t=new THREE.SphereGeometry(500,60,40);t.scale(-1,1,1);const e=new THREE.TextureLoader;e.encoding=THREE.sRGBEncoding;const i=e.load(this.imageUrl,(()=>{i.encoding=THREE.sRGBEncoding,i.wrapS=THREE.RepeatWrapping,i.repeat.x=1,i.minFilter=THREE.LinearFilter,i.magFilter=THREE.LinearFilter,i.generateMipmaps=!1;const e=new THREE.MeshBasicMaterial({map:i,side:THREE.DoubleSide});this.sphere=new THREE.Mesh(t,e),this.scene.add(this.sphere)}));this.observer.observe(this.container),this.setupEventListeners(),this.activate()}createRenderer(){const t=new THREE.WebGLRenderer({antialias:!0,powerPreference:"low-power",preserveDrawingBuffer:!0});return t.setPixelRatio(Math.min(window.devicePixelRatio,2)),t.setSize(this.container.clientWidth,this.container.clientHeight),t.outputEncoding=THREE.sRGBEncoding,t.gammaFactor=2.2,t.gammaOutput=!0,t}activate(){this.isDisposed||(t.size>=3&&Array.from(t)[0].deactivate(),t.add(this),this.startAnimation())}deactivate(){this.isDisposed||(t.delete(this),this.stopAnimation())}startAnimation(){this.isAnimating||(this.isAnimating=!0,this.animate())}stopAnimation(){this.isAnimating=!1}dispose(){this.isDisposed||(this.isDisposed=!0,this.deactivate(),this.observer.disconnect(),this.sphere&&(this.sphere.geometry.dispose(),this.sphere.material.map?.dispose(),this.sphere.material.dispose(),this.scene.remove(this.sphere)),this.scene&&this.scene.clear(),this.renderer&&(this.renderer.dispose(),this.container.removeChild(this.renderer.domElement)),this.removeEventListeners(),this.controlsContainer&&this.container.removeChild(this.controlsContainer),this.scene=null,this.camera=null,this.renderer=null,this.sphere=null,this.controlsContainer=null)}setupEventListeners(){this.isMobile||(this.fullscreenButton=document.createElement("button"),this.fullscreenButton.className="psv-btn psv-fullscreen-btn",this.fullscreenButton.title="フルスクリーン",this.fullscreenButton.innerHTML="⛶",this.fullscreenButton.onclick=t=>{t.stopPropagation(),console.log("フルスクリーンボタン onclick"),this.toggleFullscreen()},this.container.appendChild(this.fullscreenButton)),this.zoomInButton=document.createElement("button"),this.zoomInButton.className="psv-btn psv-zoom-btn psv-zoom-in-btn",this.zoomInButton.title="ズームイン",this.zoomInButton.innerHTML="+",this.zoomInButton.onclick=t=>{t.stopPropagation(),this.zoomIn()},this.zoomInButton.addEventListener("touchend",(t=>{t.preventDefault(),t.stopPropagation(),this.zoomIn()}),{passive:!1}),this.container.appendChild(this.zoomInButton),this.zoomOutButton=document.createElement("button"),this.zoomOutButton.className="psv-btn psv-zoom-btn psv-zoom-out-btn",this.zoomOutButton.title="ズームアウト",this.zoomOutButton.innerHTML="−",this.zoomOutButton.onclick=t=>{t.stopPropagation(),this.zoomOut()},this.zoomOutButton.addEventListener("touchend",(t=>{t.preventDefault(),t.stopPropagation(),this.zoomOut()}),{passive:!1}),this.container.appendChild(this.zoomOutButton),this.container.addEventListener("mousedown",this.onDocumentMouseDown.bind(this),!1),this.container.addEventListener("mousemove",this.onDocumentMouseMove.bind(this),!1),this.container.addEventListener("mouseup",this.onDocumentMouseUp.bind(this),!1),this.container.addEventListener("mouseleave",this.onDocumentMouseUp.bind(this),!1),this.container.addEventListener("touchstart",this.onDocumentTouchStart.bind(this),!1),this.container.addEventListener("touchmove",this.onDocumentTouchMove.bind(this),!1),this.container.addEventListener("touchend",this.onDocumentTouchEnd.bind(this),!1),this.container.addEventListener("click",(t=>{t.target===this.zoomInButton||t.target===this.zoomOutButton||this.isMobile||t.target===this.fullscreenButton||(t.preventDefault(),t.stopPropagation())}),!1),this.updateCursor(),window.addEventListener("resize",this.onWindowResize.bind(this),!1),this.isMobile||(document.addEventListener("fullscreenchange",this.handleFullscreenChange.bind(this)),document.addEventListener("webkitfullscreenchange",this.handleFullscreenChange.bind(this)),document.addEventListener("mozfullscreenchange",this.handleFullscreenChange.bind(this)),document.addEventListener("MSFullscreenChange",this.handleFullscreenChange.bind(this)),document.addEventListener("keydown",this.handleEscapeKey.bind(this))),window.addEventListener("beforeunload",this.dispose.bind(this))}removeEventListeners(){this.isButtonTouch(event.target)||(1===event.touches.length&&this.isUserInteracting&&(event.preventDefault(),this.lon=.15*(this.onMouseDownMouseX-event.touches[0].pageX)+this.onMouseDownLon,this.lat=.15*(event.touches[0].pageY-this.onMouseDownMouseY)+this.onMouseDownLat),this.updateCursor(),window.removeEventListener("resize",this.onWindowResize.bind(this)),window.removeEventListener("keydown",this.handleEscapeKey.bind(this)),window.removeEventListener("beforeunload",this.dispose.bind(this)))}onWindowResize(){this.camera.aspect=this.container.clientWidth/this.container.clientHeight,this.camera.updateProjectionMatrix(),this.renderer.setSize(this.container.clientWidth,this.container.clientHeight)}onDocumentMouseDown(t){t.target===this.zoomInButton||t.target===this.zoomOutButton||!this.isMobile&&t.target===this.fullscreenButton||(t.preventDefault(),this.isUserInteracting=!0,this.onMouseDownMouseX=t.clientX,this.onMouseDownMouseY=t.clientY,this.onMouseDownLon=this.lon,this.onMouseDownLat=this.lat,this.stopAutoRotate(),this.updateCursor())}onDocumentMouseMove(t){this.isUserInteracting&&(this.lon=.1*(this.onMouseDownMouseX-t.clientX)+this.onMouseDownLon,this.lat=.1*(t.clientY-this.onMouseDownMouseY)+this.onMouseDownLat),this.updateCursor()}onDocumentMouseUp(){this.isUserInteracting&&(this.isUserInteracting=!1,this.restartAutoRotateWithDelay(),this.updateCursor())}onDocumentTouchStart(t){this.isButtonTouch(t.target)||1===t.touches.length&&(t.preventDefault(),this.onMouseDownMouseX=t.touches[0].pageX,this.onMouseDownMouseY=t.touches[0].pageY,this.onMouseDownLon=this.lon,this.onMouseDownLat=this.lat,this.isUserInteracting=!0,this.stopAutoRotate(),this.updateCursor())}onDocumentTouchMove(t){this.isButtonTouch(t.target)||(1===t.touches.length&&this.isUserInteracting&&(t.preventDefault(),this.lon=.15*(this.onMouseDownMouseX-t.touches[0].pageX)+this.onMouseDownLon,this.lat=.15*(t.touches[0].pageY-this.onMouseDownMouseY)+this.onMouseDownLat),this.updateCursor())}onDocumentTouchEnd(t){this.isButtonTouch(t.target)||this.isUserInteracting&&(this.isUserInteracting=!1,this.restartAutoRotateWithDelay(),this.updateCursor())}stopAutoRotate(){this.autoRotate=!1,this.autoRotateTimeout&&(clearTimeout(this.autoRotateTimeout),this.autoRotateTimeout=null),this.lastTime=0}restartAutoRotateWithDelay(){this.autoRotateTimeout&&clearTimeout(this.autoRotateTimeout),this.autoRotateTimeout=setTimeout((()=>{this.autoRotate=!0,this.lastTime=0}),3e3)}updateCursor(){this.isUserInteracting?this.container.style.cursor="grabbing":this.container.style.cursor="move"}toggleFullscreen(){this.isMobile||(console.log("フルスクリーンボタンがクリックされました"),this.isFullscreen?this.exitFullscreen():this.enterFullscreen())}enterFullscreen(){this.isMobile||(console.log("フルスクリーン開始"),screen.orientation&&screen.orientation.lock&&screen.orientation.lock("landscape").catch((t=>{console.log("画面回転ロックに失敗:",t)})),this.originalParent=this.container.parentNode,this.originalNextSibling=this.container.nextSibling,this.originalPosition=this.container.style.position,this.originalTop=this.container.style.top,this.originalLeft=this.container.style.left,this.originalWidth=this.container.style.width,this.originalHeight=this.container.style.height,this.originalZIndex=this.container.style.zIndex,this.originalBackground=this.container.style.backgroundColor,this.fullscreenOverlay=document.createElement("div"),this.fullscreenOverlay.className="psv-fullscreen-overlay",this.fullscreenOverlay.style.cssText="\n            position: fixed;\n            top: 0;\n            left: 0;\n            width: 100vw;\n            height: 100vh;\n            background: #000;\n            z-index: 9999;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n        ",this.container.style.position="relative",this.container.style.width="100vw",this.container.style.height="100vh",this.container.style.paddingTop="0",this.container.style.maxWidth="none",this.container.style.maxHeight="none",this.container.style.backgroundColor="#000",this.fullscreenOverlay.appendChild(this.container),document.body.appendChild(this.fullscreenOverlay),this.tryTrueFullscreen(),this.isFullscreen=!0,this.onFullscreenChange(),document.body.style.overflow="hidden",document.addEventListener("touchmove",this.preventScroll,{passive:!1}))}tryTrueFullscreen(){const t=document.documentElement;t.requestFullscreen?t.requestFullscreen().catch((t=>{console.log("documentElement.requestFullscreen 失敗:",t),this.tryAlternativeFullscreen()})):t.webkitRequestFullscreen?t.webkitRequestFullscreen():t.mozRequestFullScreen?t.mozRequestFullScreen():t.msRequestFullscreen?t.msRequestFullscreen():(console.log("フルスクリーンAPIが対応していません"),this.tryAlternativeFullscreen())}tryAlternativeFullscreen(){console.log("代替フルスクリーンモード");const t=document.querySelector('meta[name="viewport"]');t&&(this.originalViewport=t.getAttribute("content"),t.setAttribute("content","width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no")),/iPhone|iPad|iPod/.test(navigator.userAgent)&&setTimeout((()=>{window.scrollTo(0,1)}),100)}preventScroll(t){return t.preventDefault(),!1}exitFullscreen(){if(console.log("フルスクリーン終了"),screen.orientation&&screen.orientation.unlock&&screen.orientation.unlock(),this.originalViewport){const t=document.querySelector('meta[name="viewport"]');t&&t.setAttribute("content",this.originalViewport)}document.body.style.overflow="",document.removeEventListener("touchmove",this.preventScroll),document.removeEventListener("keydown",this.handleEscapeKey.bind(this)),this.originalParent&&(this.container.style.position=this.originalPosition,this.container.style.top=this.originalTop,this.container.style.left=this.originalLeft,this.container.style.width=this.originalWidth,this.container.style.height=this.originalHeight,this.container.style.zIndex=this.originalZIndex,this.container.style.backgroundColor=this.originalBackground,this.container.style.paddingTop="56.25%",this.container.style.maxWidth="",this.container.style.maxHeight="",this.originalNextSibling?this.originalParent.insertBefore(this.container,this.originalNextSibling):this.originalParent.appendChild(this.container)),this.fullscreenOverlay&&(this.fullscreenOverlay.remove(),this.fullscreenOverlay=null),document.exitFullscreen?document.exitFullscreen().catch((t=>{console.log("フルスクリーン終了失敗:",t)})):document.webkitExitFullscreen?document.webkitExitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.msExitFullscreen&&document.msExitFullscreen(),this.isFullscreen=!1,this.onFullscreenChange(),setTimeout((()=>{this.onWindowResize()}),100)}onFullscreenChange(){this.onWindowResize(),!this.isMobile&&this.fullscreenButton&&(this.isFullscreen?(this.fullscreenButton.innerHTML="✕",this.fullscreenButton.title="フルスクリーン終了"):(this.fullscreenButton.innerHTML="⛶",this.fullscreenButton.title="フルスクリーン"))}animate(){this.isAnimating&&!this.isDisposed&&(requestAnimationFrame(this.animate.bind(this)),this.update())}update(){if(this.autoRotate&&!this.isUserInteracting){const t=performance.now();if(this.lastTime>0){const e=(t-this.lastTime)/1e3;this.lon+=this.autoRotateSpeed*e}this.lastTime=t}else this.lastTime=performance.now();this.lat=Math.max(-85,Math.min(85,this.lat)),this.phi=THREE.MathUtils.degToRad(90-this.lat),this.theta=THREE.MathUtils.degToRad(this.lon),this.camera.position.x=100*Math.sin(this.phi)*Math.cos(this.theta),this.camera.position.y=100*Math.cos(this.phi),this.camera.position.z=100*Math.sin(this.phi)*Math.sin(this.theta),this.camera.lookAt(this.camera.target),this.renderer.render(this.scene,this.camera)}zoomIn(){this.camera.fov=Math.max(30,this.camera.fov-10),this.camera.updateProjectionMatrix()}zoomOut(){this.camera.fov=Math.min(90,this.camera.fov+10),this.camera.updateProjectionMatrix()}isButtonTouch(t){return t===this.zoomInButton||t===this.zoomOutButton||!this.isMobile&&t===this.fullscreenButton||t.closest(".psv-btn")}handleFullscreenChange(){if(this.isMobile)return;const t=!!(document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement||document.msFullscreenElement);this.isFullscreen=t,this.onFullscreenChange()}handleEscapeKey(t){this.isMobile||"Escape"===t.key&&this.isFullscreen&&this.exitFullscreen()}}document.addEventListener("DOMContentLoaded",(function(){const t=document.querySelectorAll(".psv-container"),i=new Map;t.forEach((t=>{const n=t.getAttribute("data-img");if(n){const s=new e(t,n);i.set(t,s)}})),window.addEventListener("beforeunload",(()=>{i.forEach((t=>t.dispose())),i.clear()}))}))})();